<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImaginAI - AI Image Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        body { font-family: 'Inter', sans-serif; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #1e293b; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #475569; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #64748b; }

        @keyframes gradient-xy {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .animate-gradient-xy {
            background-size: 200% 200%;
            animation: gradient-xy 3s ease infinite;
        }
        
        /* Glass effect class */
        .glass {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 text-slate-100 flex flex-col md:flex-row overflow-hidden selection:bg-purple-500 selection:text-white">

    <!-- Mobile Header -->
    <div class="md:hidden p-4 bg-slate-800 border-b border-slate-700 flex justify-between items-center z-20">
        <div class="flex items-center gap-2 font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">
            <i data-lucide="sparkles" class="w-6 h-6 text-purple-400"></i>
            <span>ImaginAI</span>
        </div>
        <button id="mobileMenuBtn" class="p-2 bg-slate-700 rounded-lg hover:bg-slate-600 transition-colors">
            <i data-lucide="history" id="menuIcon"></i>
        </button>
    </div>

    <!-- Sidebar (History) -->
    <div id="sidebar" class="fixed inset-y-0 left-0 z-30 w-64 bg-slate-800 border-r border-slate-700 transform -translate-x-full transition-transform duration-300 ease-in-out md:translate-x-0 md:static md:flex-shrink-0 flex flex-col">
        <div class="p-6 border-b border-slate-700 hidden md:flex items-center gap-2 font-bold text-2xl">
            <i data-lucide="sparkles" class="w-8 h-8 text-purple-400"></i>
            <span class="bg-clip-text text-transparent bg-gradient-to-r from-purple-400 to-pink-600">ImaginAI</span>
        </div>

        <div class="flex-1 overflow-y-auto p-4 space-y-4 custom-scrollbar" id="historyContainer">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Recent</h3>
                <button id="clearHistoryBtn" class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1 transition-colors hidden">
                    <i data-lucide="trash-2" class="w-3 h-3"></i> Clear
                </button>
            </div>
            
            <div id="emptyHistory" class="text-center py-10 text-slate-500">
                <i data-lucide="history" class="w-8 h-8 mx-auto mb-2 opacity-50"></i>
                <p class="text-sm">No images yet.<br/>Start creating!</p>
            </div>
            
            <div id="historyList" class="space-y-4">
                <!-- History items will be injected here -->
            </div>
        </div>
    </div>

    <!-- Mobile Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black/60 z-20 md:hidden glass hidden"></div>

    <!-- Main Content -->
    <div class="flex-1 flex flex-col h-[calc(100vh-64px)] md:h-screen overflow-hidden bg-slate-900 relative">
        
        <!-- Input Section -->
        <div class="w-full max-w-4xl mx-auto p-4 md:p-8 z-10">
            <div class="bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-2xl p-2 shadow-2xl flex flex-col md:flex-row gap-2 transition-all focus-within:ring-2 focus-within:ring-purple-500/50 focus-within:border-purple-500">
                <input
                    id="promptInput"
                    type="text"
                    placeholder="Describe what you want to see... (e.g., A cyberpunk city in neon rain)"
                    class="flex-1 bg-transparent border-none text-white placeholder-slate-400 p-4 focus:outline-none text-lg"
                />
                <button
                    id="generateBtn"
                    class="px-8 py-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 flex items-center justify-center gap-2 min-w-[140px] bg-slate-700 cursor-not-allowed text-slate-400"
                    disabled
                >
                    <i data-lucide="sparkles" class="w-5 h-5 btn-icon"></i>
                    <span id="btnText">Generate</span>
                </button>
            </div>
            <div id="errorMessage" class="hidden mt-4 p-4 bg-red-500/10 border border-red-500/50 text-red-200 rounded-xl flex items-center gap-3 animate-in fade-in slide-in-from-top-4">
                <i data-lucide="alert-circle" class="w-5 h-5 flex-shrink-0"></i>
                <p id="errorText"></p>
            </div>
        </div>

        <!-- Preview Area -->
        <div class="flex-1 overflow-y-auto p-4 md:p-8 flex items-center justify-center min-h-0" id="previewArea">
            
            <!-- Welcome State -->
            <div id="welcomeState" class="text-center text-slate-500 max-w-md p-8 border-2 border-dashed border-slate-700 rounded-3xl bg-slate-800/30">
                <div class="bg-slate-800 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                    <i data-lucide="image" class="w-10 h-10 text-slate-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-slate-300 mb-2">Ready to Create?</h2>
                <p class="text-slate-400 mb-6 leading-relaxed">
                    Enter a prompt above to unleash your creativity. Try being specific about lighting, style, and mood!
                </p>
                <div class="flex flex-wrap gap-2 justify-center">
                    <span class="cursor-pointer hover:bg-slate-600 transition-colors text-xs bg-slate-700 text-slate-300 px-3 py-1 rounded-full border border-slate-600 prompt-chip">Oil painting</span>
                    <span class="cursor-pointer hover:bg-slate-600 transition-colors text-xs bg-slate-700 text-slate-300 px-3 py-1 rounded-full border border-slate-600 prompt-chip">Cyberpunk</span>
                    <span class="cursor-pointer hover:bg-slate-600 transition-colors text-xs bg-slate-700 text-slate-300 px-3 py-1 rounded-full border border-slate-600 prompt-chip">3D Render</span>
                    <span class="cursor-pointer hover:bg-slate-600 transition-colors text-xs bg-slate-700 text-slate-300 px-3 py-1 rounded-full border border-slate-600 prompt-chip">Minimalist</span>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="hidden flex flex-col items-center justify-center space-y-8 animate-pulse">
                <div class="relative w-64 h-64 md:w-96 md:h-96 rounded-lg bg-slate-800 overflow-hidden shadow-inner flex items-center justify-center">
                    <div class="absolute inset-0 bg-gradient-to-tr from-indigo-500/20 via-purple-500/20 to-pink-500/20 animate-gradient-xy"></div>
                    <i data-lucide="sparkles" class="w-16 h-16 text-slate-600 animate-bounce"></i>
                </div>
                <div class="space-y-3 text-center">
                    <h3 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-pink-400 animate-pulse">Dreaming up your image...</h3>
                    <p class="text-slate-400">This usually takes about 5-10 seconds.</p>
                </div>
            </div>

            <!-- Image Result -->
            <div id="resultState" class="hidden relative w-full h-full max-h-[70vh] flex flex-col items-center justify-center animate-in zoom-in-95 duration-500">
                <div class="relative group max-w-full max-h-full shadow-2xl shadow-purple-900/20 rounded-lg overflow-hidden border border-slate-700">
                    <img id="generatedImage" src="" alt="Generated" class="max-w-full max-h-[calc(100vh-250px)] object-contain bg-slate-800" />
                    <div class="absolute inset-x-0 bottom-0 p-4 bg-gradient-to-t from-black/80 via-black/40 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300 flex justify-center pb-6">
                        <button id="downloadBtn" class="bg-white text-slate-900 hover:bg-slate-200 px-6 py-2 rounded-full font-bold flex items-center gap-2 transition-colors shadow-lg transform hover:scale-105">
                            <i data-lucide="download" class="w-4 h-4"></i> Download
                        </button>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const apiKey = ""; // Injected by the environment

        // State variables
        let history = [];
        let currentPrompt = "";
        let isLoading = false;
        let isSidebarOpen = false;

        // DOM Elements
        const promptInput = document.getElementById('promptInput');
        const generateBtn = document.getElementById('generateBtn');
        const btnText = document.getElementById('btnText');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        
        const welcomeState = document.getElementById('welcomeState');
        const loadingState = document.getElementById('loadingState');
        const resultState = document.getElementById('resultState');
        const generatedImage = document.getElementById('generatedImage');
        const downloadBtn = document.getElementById('downloadBtn');

        const historyList = document.getElementById('historyList');
        const emptyHistory = document.getElementById('emptyHistory');
        const clearHistoryBtn = document.getElementById('clearHistoryBtn');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const menuIcon = document.getElementById('menuIcon');

        // Initialization
        window.onload = () => {
            lucide.createIcons();
            promptInput.focus();
            updateHistoryUI();
        };

        // Event Listeners
        promptInput.addEventListener('input', updateButtonState);
        promptInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !isLoading) generateImage();
        });
        
        generateBtn.addEventListener('click', generateImage);
        
        downloadBtn.addEventListener('click', () => {
            downloadImage(generatedImage.src, currentPrompt);
        });

        clearHistoryBtn.addEventListener('click', () => {
            history = [];
            updateHistoryUI();
        });

        mobileMenuBtn.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', toggleSidebar);

        document.querySelectorAll('.prompt-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                promptInput.value = promptInput.value + (promptInput.value ? " " : "") + chip.innerText;
                updateButtonState();
                promptInput.focus();
            });
        });

        // UI Helpers
        function updateButtonState() {
            const hasText = promptInput.value.trim().length > 0;
            if (hasText && !isLoading) {
                generateBtn.disabled = false;
                generateBtn.className = "px-8 py-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 flex items-center justify-center gap-2 min-w-[140px] bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 hover:shadow-purple-500/30 active:scale-95";
            } else {
                generateBtn.disabled = true;
                generateBtn.className = "px-8 py-4 rounded-xl font-bold text-white shadow-lg transition-all duration-300 flex items-center justify-center gap-2 min-w-[140px] bg-slate-700 cursor-not-allowed text-slate-400";
            }
        }

        function toggleSidebar() {
            isSidebarOpen = !isSidebarOpen;
            if (isSidebarOpen) {
                sidebar.classList.remove('-translate-x-full');
                sidebarOverlay.classList.remove('hidden');
                menuIcon.setAttribute('data-lucide', 'x');
            } else {
                sidebar.classList.add('-translate-x-full');
                sidebarOverlay.classList.add('hidden');
                menuIcon.setAttribute('data-lucide', 'history');
            }
            lucide.createIcons();
        }

        function setView(state) {
            welcomeState.classList.add('hidden');
            loadingState.classList.add('hidden');
            resultState.classList.add('hidden');

            if (state === 'welcome') welcomeState.classList.remove('hidden');
            if (state === 'loading') loadingState.classList.remove('hidden');
            if (state === 'result') resultState.classList.remove('hidden');
        }

        function showError(msg) {
            if (msg) {
                errorText.innerText = msg;
                errorMessage.classList.remove('hidden');
            } else {
                errorMessage.classList.add('hidden');
            }
        }

        // Core Logic
        async function generateImage() {
            const prompt = promptInput.value.trim();
            if (!prompt) return;

            isLoading = true;
            currentPrompt = prompt;
            showError(null);
            setView('loading');
            updateButtonState();
            
            // Update button visual to loading
            const originalBtnContent = generateBtn.innerHTML;
            generateBtn.innerHTML = `<i data-lucide="refresh-cw" class="w-5 h-5 animate-spin"></i> Generating`;
            lucide.createIcons();

            const maxRetries = 5;
            let attempt = 0;
            let success = false;
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            while (attempt < maxRetries && !success) {
                try {
                    const response = await fetch(
                        `https://generativelanguage.googleapis.com/v1beta/models/imagen-4.0-generate-001:predict?key=${apiKey}`,
                        {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                instances: { prompt: prompt },
                                parameters: { sampleCount: 1 }
                            }),
                        }
                    );

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();

                    if (result.predictions && result.predictions[0]?.bytesBase64Encoded) {
                        const base64Image = `data:image/png;base64,${result.predictions[0].bytesBase64Encoded}`;
                        
                        // Success
                        generatedImage.src = base64Image;
                        setView('result');
                        
                        // Add to history
                        history.unshift({
                            id: Date.now(),
                            prompt: prompt,
                            url: base64Image
                        });
                        updateHistoryUI();
                        
                        success = true;
                    } else {
                        throw new Error("No image data returned. The prompt might have triggered safety filters.");
                    }

                } catch (err) {
                    attempt++;
                    if (attempt >= maxRetries) {
                        showError(err.message || "Failed to generate image. Please try again.");
                        setView('welcome'); // Go back to start on total fail
                    } else {
                        await delay(Math.pow(2, attempt - 1) * 1000);
                    }
                }
            }

            isLoading = false;
            generateBtn.innerHTML = `<i data-lucide="sparkles" class="w-5 h-5"></i> Generate`;
            lucide.createIcons();
            updateButtonState();
        }

        function updateHistoryUI() {
            historyList.innerHTML = '';
            
            if (history.length === 0) {
                emptyHistory.classList.remove('hidden');
                clearHistoryBtn.classList.add('hidden');
            } else {
                emptyHistory.classList.add('hidden');
                clearHistoryBtn.classList.remove('hidden');

                history.forEach(item => {
                    const isActive = generatedImage.src === item.url;
                    const div = document.createElement('div');
                    div.className = `group cursor-pointer rounded-xl overflow-hidden border-2 transition-all duration-200 ${isActive ? 'border-purple-500 shadow-lg shadow-purple-500/20' : 'border-transparent hover:border-slate-600 bg-slate-700/50'}`;
                    div.onclick = () => {
                        generatedImage.src = item.url;
                        promptInput.value = item.prompt;
                        currentPrompt = item.prompt;
                        setView('result');
                        updateButtonState();
                        if(window.innerWidth < 768) toggleSidebar(); // Close sidebar on mobile
                        updateHistoryUI(); // Re-render to update active border
                    };
                    
                    div.innerHTML = `
                        <div class="aspect-square w-full relative">
                            <img src="${item.url}" alt="Thumbnail" class="w-full h-full object-cover" />
                            <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center">
                                <span class="text-xs font-medium text-white bg-black/50 px-2 py-1 rounded-full">View</span>
                            </div>
                        </div>
                        <div class="p-2">
                            <p class="text-xs text-slate-300 line-clamp-2 leading-relaxed">${item.prompt}</p>
                        </div>
                    `;
                    historyList.appendChild(div);
                });
            }
        }

        // Improved Download Logic
        function downloadImage(imageUrl, promptText) {
            try {
                // Convert Base64 to Blob
                const byteString = atob(imageUrl.split(',')[1]);
                const mimeString = imageUrl.split(',')[0].split(':')[1].split(';')[0];
                const ab = new ArrayBuffer(byteString.length);
                const ia = new Uint8Array(ab);
                for (let i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }
                const blob = new Blob([ab], { type: mimeString });
                
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                
                const safePrompt = promptText.substring(0, 30).replace(/[^a-z0-9]/gi, '-').replace(/-+/g, '-').toLowerCase();
                link.download = `imaginai-${safePrompt}-${Date.now()}.png`;
                
                document.body.appendChild(link);
                link.click();
                
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);

            } catch (err) {
                console.error("Download failed:", err);
                const w = window.open("");
                if (w) {
                    w.document.write(`<img src="${imageUrl}" style="width:100%"/>`);
                } else {
                    alert("Download failed and popups are blocked. Right-click the image to save.");
                }
            }
        }
    </script>
</body>
</html>